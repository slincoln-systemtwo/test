// Name: Lampion Malware VBS Persistence and Execution
// Tactic: Persistence, Execution
// Technique: T1547.001, T1053.005, T1529
// Description: Detects VBScript execution patterns associated with Lampion malware. This includes writing a command file to a startup folder and scheduling or initiating a system shutdown, a technique used by Lampion to trigger its next stage.
// Reference: https://unit42.paloaltonetworks.com/lampion-malware-clickfix-lures/
// False Positive Sensitivity: Medium
// Author: detections.ai
// Date: 2025-07-07

// Define script hosts of interest
let script_hosts = dynamic(["wscript.exe", "cscript.exe"]);
// Define common startup folder paths
let startup_folders = dynamic([
    @"\Start Menu\Programs\Startup\",
    @"\Microsoft\Windows\Start Menu\Programs\Startup\"
]);

(union isfuzzy=true
    (
        // Detects a script host writing a .cmd file to a startup folder
        DeviceFileEvents
        | where InitiatingProcessFileName in~ (script_hosts)
        | where FolderPath has_any (startup_folders) and FileName endswith ".cmd"
        | extend
            Activity = "VBS wrote CMD to Startup",
            Tactic = "Persistence",
            Technique = "T1547.001",
            // Add empty columns for union compatibility
            ProcessCommandLine = "",
            ChildProcessFileName = FileName
        | project-rename FileName = CreatedFileName
    ),
    (
        // Detects a script host scheduling a shutdown or reboot
        DeviceProcessEvents
        | where InitiatingProcessFileName in~ (script_hosts)
        // FP Note: Legitimate administrative scripts may perform shutdown actions.
        // Consider excluding known script paths or parent processes if noise occurs.
        | where
            (FileName =~ "schtasks.exe" and ProcessCommandLine has_all ("/create", "shutdown")) or
            (FileName =~ "shutdown.exe")
        | extend
            Activity = iif(FileName =~ "schtasks.exe", "VBS Scheduled Shutdown Task", "VBS Direct Shutdown"),
            Tactic = "Execution",
            Technique = iif(FileName =~ "schtasks.exe", "T1053.005", "T1529"),
            // Add empty columns for union compatibility
            FolderPath = "",
            CreatedFileName = "",
            FileSHA1 = ""
        | project-rename FileName = ChildProcessFileName
    )
)
| project
    Timestamp,
    DeviceName,
    Activity,
    Tactic,
    Technique,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    ChildProcessFileName,
    ProcessCommandLine,
    FolderPath,
    CreatedFileName,
    SHA1
